{% extends 'admin/navbar.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
    .preview img {
        max-width: 300px; 
        max-height: 300px; 
        display: block;
        margin: auto;
    }
    .preview {
        width: 300px;
        height: 300px;
        overflow: hidden;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
        position: relative;
    }
    .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: red;
        color: white;
        border: none;
        padding: 5px 8px;
        cursor: pointer;
        font-size: 12px;
        border-radius: 3px;
    }
</style>

<div class="container mt-5">
    <h2 class="text-center mb-4">Add Variant</h2>
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Color Selection -->
        <div class="form-group">
            <label for="color">Color</label>
            <select class="form-control" id="color" name="color">
                <option value="Black">Black</option>
                <option value="White">White</option>
                <option value="Red">Red</option>
                <option value="Blue">Blue</option>
            </select>
        </div>

        <!-- Stock Input -->
        <div class="form-group">
            <label for="stock">Stock</label>
            <input type="number" class="form-control" id="stock" name="stock" placeholder="Enter stock quantity">
        </div>

        <!-- Image 1 Upload and Preview -->
        <div class="form-group">
            <label for="image1">Image 1</label>
            <input type="file" class="form-control image-input" id="image1" name="image1" accept="image/*">
            <div id="preview1" class="preview mt-2"></div>
            <input type="hidden" id="cropped-image1" name="cropped_image1">
        </div>

        <!-- Image 2 Upload and Preview -->
        <div class="form-group">
            <label for="image2">Image 2</label>
            <input type="file" class="form-control image-input" id="image2" name="image2" accept="image/*">
            <div id="preview2" class="preview mt-2"></div>
            <input type="hidden" id="cropped-image2" name="cropped_image2">
        </div>

        <!-- Image 3 Upload and Preview -->
        <div class="form-group">
            <label for="image3">Image 3</label>
            <input type="file" class="form-control image-input" id="image3" name="image3" accept="image/*">
            <div id="preview3" class="preview mt-2"></div>
            <input type="hidden" id="cropped-image3" name="cropped_image3">
        </div>

        <button type="submit" class="btn btn-primary mt-3">Add Variant</button>
    </form>
</div>

<!-- Include Cropper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputs = document.querySelectorAll('.image-input');
    let croppers = {}; // Store cropper instances

    inputs.forEach(input => {
        input.addEventListener('change', function (e) {
            const previewId = "preview" + this.id.replace("image", "");
            const preview = document.getElementById(previewId);
            const hiddenInputId = 'cropped-image' + this.id.replace('image', '');

            // Clear the previous preview and destroy existing cropper
            if (croppers[this.id]) {
                croppers[this.id].destroy();
                croppers[this.id] = null;
            }
            preview.innerHTML = '';

            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    // Create container for better control
                    const container = document.createElement('div');
                    container.style.maxWidth = '100%';
                    container.style.width = '100%';
                    preview.appendChild(container);

                    // Create and setup image
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.maxWidth = '100%';
                    container.appendChild(img);

                    // Wait for image to load before initializing cropper
                    img.onload = function() {
                        // Initialize Cropper.js with improved options
                        croppers[input.id] = new Cropper(img, {
                            aspectRatio: 1,
                            viewMode: 2, // Changed to viewMode 2 for better visibility
                            autoCropArea: 1,
                            cropBoxResizable: true,
                            cropBoxMovable: true,
                            dragMode: 'move',
                            responsive: true,
                            restore: false,
                            ready: function() {
                                // Set crop box after cropper is fully initialized
                                this.cropper.setCropBoxData({
                                    width: Math.min(300, preview.offsetWidth),
                                    height: Math.min(300, preview.offsetWidth)
                                });
                            }
                        });
                    };

                    // Add Crop Button
                    const cropButton = document.createElement('button');
                    cropButton.textContent = "Crop";
                    cropButton.classList.add('btn', 'btn-secondary', 'mt-2');
                    preview.appendChild(cropButton);

                    cropButton.addEventListener('click', function (e) {
                        e.preventDefault();
                        const cropper = croppers[input.id];
                        if (cropper) {
                            const croppedCanvas = cropper.getCroppedCanvas({
                                width: 300,
                                height: 300,
                                imageSmoothingEnabled: true,
                                imageSmoothingQuality: 'high'
                            });

                            // Create a blob from the canvas
                            croppedCanvas.toBlob(function(blob) {
                                // Create a new File object
                                const croppedFile = new File([blob], file.name, {
                                    type: file.type,
                                    lastModified: new Date().getTime()
                                });

                                // Update the file input with the cropped image
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(croppedFile);
                                input.files = dataTransfer.files;
                            }, file.type, 0.9);

                            // Update preview
                            const croppedImage = document.createElement('img');
                            croppedImage.src = croppedCanvas.toDataURL(file.type, 0.9);
                            croppedImage.style.maxWidth = '100%';
                            preview.innerHTML = '';
                            preview.appendChild(croppedImage);

                            // Add Remove Button
                            addRemoveButton(preview, input);

                            // Destroy cropper after cropping
                            cropper.destroy();
                            croppers[input.id] = null;
                        }
                    });

                    // Add Remove Button
                    addRemoveButton(preview, input);
                };
                reader.readAsDataURL(file);
            }
        });
    });

    function addRemoveButton(preview, input) {
        const removeButton = document.createElement('button');
        removeButton.textContent = "Remove";
        removeButton.classList.add('remove-btn');
        preview.appendChild(removeButton);

        removeButton.addEventListener('click', function (e) {
            e.preventDefault();
            preview.innerHTML = '';
            input.value = '';
            if (croppers[input.id]) {
                croppers[input.id].destroy();
                croppers[input.id] = null;
            }
        });
    }
});
</script>

{% endblock %}

